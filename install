#!/bin/bash
set -euo pipefail

# ===============================================
# Dotfiles Main Installer
# ===============================================
# Primary entry point for setting up the entire development environment.
# Orchestrates the complete installation process including dotfiles setup
# and package installation.
#
# Author: Alexis
# Version: 2.0
# Last Updated: 2025-08-07

# Initialize comprehensive error handling
SCRIPT_NAME="dotfiles-install"

# Define absolute paths regardless of where the script is called from
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)"
DOTFILES_DIR="$(cd "$SCRIPT_DIR" && pwd)"

# Source comprehensive error handling system
if [ -f "$DOTFILES_DIR/scripts/error_handling" ]; then
    source "$DOTFILES_DIR/scripts/error_handling"
    init_error_handling "$SCRIPT_NAME"
else
    # Fallback to basic error handling
    set -euo pipefail
fi

# Source logging utilities if available, or create minimal logging functions
if [ -f "$DOTFILES_DIR/scripts/logs" ]; then
    source "$DOTFILES_DIR/scripts/logs"
else
    # Fallback logging functions
    # Function to get current timestamp in ISO 8601 format
    get_timestamp() {
      date +"%Y-%m-%d %H:%M:%S"
    }

    # Core logging functions with timestamp and log type - no fancy formatting
    log() { echo "[$(get_timestamp)][INFO] $1"; }
    log_error() { echo "[$(get_timestamp)][ERROR] $1"; }
    log_success() { echo "[$(get_timestamp)][SUCCESS] $1"; }
    log_warning() { echo "[$(get_timestamp)][WARNING] $1"; }
    log_progress() { echo "[$(get_timestamp)][PROGRESS] $1"; }
    log_complete() { echo "[$(get_timestamp)][COMPLETE] $1"; }

    # Error and exit helper
    error_exit() { log_error "$1"; exit 1; }

    # Simple section header
    section_header() {
        echo -e "\n===== $1 =====\n"
    }
fi

# Source utility functions
if [ -f "$DOTFILES_DIR/scripts/utils" ]; then
    source "$DOTFILES_DIR/scripts/utils"
fi

# ===============================================
# Utility Functions
# ===============================================

# Validate multiple prerequisites and return 0 if all are available, 1 if any are missing
validate_prerequisites() {
    local missing_tools=()
    
    if [ $# -eq 0 ]; then
        log_warning "No prerequisites specified for validation"
        return 0
    fi
    
    log_progress "Validating prerequisites: $*"
    
    for tool in "$@"; do
        if [ -z "$tool" ]; then
            continue
        fi
        
        if ! command -v "$tool" &> /dev/null; then
            missing_tools+=("$tool")
        fi
    done
    
    if [ ${#missing_tools[@]} -gt 0 ]; then
        log_error "Missing required tools: ${missing_tools[*]}"
        log_error "Please install these tools before running the installer"
        return 1
    fi
    
    log_success "All prerequisites validated: $*"
    return 0
}

# Display help information when requested
if [[ "${1:-}" == "--help" ]]; then
    section_header "Dotfiles Installer"
    echo "Usage: ./install [--help]"
    echo "This script sets up the dotfiles environment."
    echo
    echo "The installation process will:"
    echo "  1. Run the setup_dotfiles script to configure dotfiles and update git submodules"
    echo "  2. Install required packages"
    echo
    exit 0
fi

# Set non-interactive mode for automated installations
export DEBIAN_FRONTEND=noninteractive

section_header "Dotfiles Installation"

# Validate prerequisites
validate_prerequisites "git" "curl" "tar" || {
    log_error "Prerequisites validation failed. Please install missing tools and try again."
    exit 1
}


# ===============================================
# Installation Process
# ===============================================

# Installation steps with comprehensive logging
log_progress "Starting dotfiles installation process"

# Step 1: Run setup script to initialize the environment
section_header "Dotfiles Setup and Configuration"
log_progress "Executing dotfiles setup script"

if [ ! -f "$DOTFILES_DIR/setup_dotfiles" ]; then
    error_exit "Setup script not found: $DOTFILES_DIR/setup_dotfiles"
fi

if [ ! -x "$DOTFILES_DIR/setup_dotfiles" ]; then
    log_warning "Setup script not executable, attempting to fix"
    chmod +x "$DOTFILES_DIR/setup_dotfiles" || error_exit "Failed to make setup script executable"
fi

if bash "$DOTFILES_DIR/setup_dotfiles"; then
    log_success "Dotfiles setup completed successfully"
else
    error_exit "Failed to run dotfiles setup (exit code: $?)"
fi

# Step 2: Install required development tools
section_header "Development Tools Installation"
log_progress "Installing required development packages"

if [ ! -f "$DOTFILES_DIR/scripts/install_packages" ]; then
    error_exit "Package installer not found: $DOTFILES_DIR/scripts/install_packages"
fi

if [ ! -x "$DOTFILES_DIR/scripts/install_packages" ]; then
    log_warning "Package installer not executable, attempting to fix"
    chmod +x "$DOTFILES_DIR/scripts/install_packages" || error_exit "Failed to make package installer executable"
fi

if bash "$DOTFILES_DIR/scripts/install_packages"; then
    log_success "Package installation completed successfully"
else
    log_warning "Package installation completed with warnings (exit code: $?)"
    log_warning "Some packages may not have been installed correctly"
fi

section_header "Installation Complete"
log_complete "Dotfiles have been successfully installed!"
echo
echo "Your new environment is ready to use."
echo "Please restart your terminal or run exec bash to apply all changes."
